[[template]]
name = "jspm:generate"
definition = """({ autoInstall = false, generatorEnv = ['browser', 'production', 'module'], ...generateOpts }) => [{
  deps: ['node_modules/@jspm/generator', 'node_modules/mkdirp'],
  engine: 'node',
  run: `
    import { Generator } from '@jspm/generator';
    import { readFile, writeFile } from 'fs/promises';
    import { pathToFileURL } from 'url';
    import mkdirp from 'mkdirp';
    import { dirname } from 'path';

    const htmlUrl = pathToFileURL(process.env.TARGET);
    const generator = new Generator({
      mapUrl: htmlUrl,
      env: ${JSON.stringify(generatorEnv)}
    });

    const htmlSource = await readFile(process.env.DEP, 'utf-8');
    const opts = ${JSON.stringify(generateOpts)};
    opts.htmlUrl = htmlUrl;
    const outHtml = await generator.htmlGenerate(htmlSource, opts);

    mkdirp.sync(dirname(process.env.TARGET));
    await writeFile(process.env.TARGET, outHtml);
  `
}, {
  template: autoInstall ? 'npm:install' : 'npm:verify',
  args: {
    packages: ['@jspm/generator', 'mkdirp'],
    dev: true
  }
}]
"""
